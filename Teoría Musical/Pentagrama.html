<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO -->
    <title>Pentagrama, claves y figuras rítmicas | Aprende música online con Sprinkloud</title>
    <meta name="description" content="Aprende los fundamentos de la música de forma interactiva. Explora el pentagrama, las claves, las notas musicales, las figuras rítmicas y practica con nuestro piano virtual. ¡Empieza tu aventura musical con Sprinkloud!">
    <meta name="keywords" content="aprender música, teoría musical, pentagrama, clave de sol, notas musicales, figuras rítmicas, piano virtual, Sprinkloud, educación musical">


    <!-- VexFlow -->
    <script src="https://unpkg.com/vexflow/releases/vexflow-min.js"></script>

    <!-- Tone.js -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Librerías de Música (Versiones estables y actualizadas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vexflow/4.2.3/vexflow.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #073B4C;
            color: #FFFFFF;
        }
        .piano-key {
            border: 1px solid #073B4C;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            transition: all 0.1s ease-out;
            cursor: pointer;
        }
        .white-key {
            background-color: white;
            color: #333;
        }
        .black-key {
            background-color: #222;
            color: white;
            z-index: 10;
        }
        .key-active {
            transform: scale(0.98) translateY(2px);
            background: linear-gradient(to bottom, #D4AF37, #b89a3a);
            box-shadow: 0px 0px 5px #D4AF37;
        }
        .note-highlight {
            fill: #D4AF37 !important;
            stroke: #D4AF37 !important;
        }
        .feedback-correct {
            animation: flash-green 0.5s ease-out;
        }
        .feedback-incorrect {
            animation: flash-red 0.5s ease-out;
        }
        @keyframes flash-green {
            0%, 100% { background-color: #2A9D8F; }
            50% { background-color: #3fdbc6; }
        }
        @keyframes flash-red {
            0%, 100% { background-color: #e53e3e; }
            50% { background-color: #fc8181; }
        }
        .bg-[#115164] {
            background-color: #115164;
        }
        .rhythm-figure svg {
            height: 80px; /* Matches h-20 in Tailwind */
            margin: 0 auto 8px;
            filter: invert(100%) brightness(0); /* Matches invert brightness-0 */
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 2rem; /* Matches gap-8 in Tailwind */
        }
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        .text-center {
            text-align: center;
        }
        .font-semibold {
            font-weight: 600;
        }
        .text-3xl {
            font-size: 1.875rem;
            line-height: 2.25rem;
        }
        .font-bold {
            font-weight: 700;
        }
        .mb-8 {
            margin-bottom: 2rem;
        }
        .mb-16 {
            margin-bottom: 4rem;
        }
        .p-8 {
            padding: 2rem;
        }
        .rounded-2xl {
            border-radius: 1rem;
        }
        .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

<!-- Modal de Inicio
<div id="start-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50">
    <div class="text-center p-8 rounded-lg">
        <h2 class="text-3xl md:text-5xl font-bold text-white mb-6">Bienvenido a la Lección Interactiva</h2>
        <button id="start-button" class="bg-[#2A9D8F] text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-[#3fdbc6] transition-transform duration-300 hover:scale-105 text-xl">
            ¡Empezar a Aprender!
        </button>
    </div>
</div> -->

<!-- Header -->
<header class="container mx-auto px-6 py-4 flex justify-center items-center">
    <a href="https://sprinkloud.vercel.app/" target="_blank">
        <img src="LOGO_Sprinkloud__6_-removebg-preview.png"
             alt="Sprinkloud Club Musical Logo"
             class="h-24 md:h-32 object-contain transition-transform duration-300 hover:scale-105">
    </a>
</header>

<main class="container mx-auto px-6 py-8">
    <!-- Título principal SEO -->
    <h1 class="text-3xl md:text-5xl font-bold text-center mb-12 text-[#D4AF37]">
        Pentagrama, claves y figuras rítmicas
    </h1>

    <!-- Sección Interactiva Principal -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center mb-16">
        <!-- Columna del Pentagrama -->
        <div class="bg-[#115164] p-6 rounded-2xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-center">El Pentagrama y las Notas</h2>
            <p class="text-center mb-4 text-gray-300">Haz clic en una nota en el pentagrama para escucharla y verla en el piano.</p>
            <div id="staff-container" class="w-full h-48 flex justify-center items-center"></div>
        </div>

        <!-- Columna del Teclado -->
        <div class="bg-[#115164] p-6 rounded-2xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-center">El Piano</h2>
            <p class="text-center mb-4 text-gray-300">Haz clic en una tecla para escucharla y verla en el pentagrama.</p>
            <div id="piano-container" class="relative flex justify-center h-48 select-none">
                <!-- Las teclas del piano se generarán aquí con JS -->
            </div>
        </div>
    </section>

    <!-- Sección Figuras Rítmicas -->
    <section class="bg-[#115164] p-8 rounded-2xl shadow-2xl mb-16">
        <h2 class="text-3xl font-bold text-center mb-8">Figuras Rítmicas</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
            <!-- Figura: Redonda -->
            <div class="rhythm-figure" data-duration="1n" data-name="Redonda">
                <div id="redonda"></div>
                <p class="font-semibold">Redonda (4 tiempos)</p>
            </div>
            <!-- Figura: Blanca -->
            <div class="rhythm-figure" data-duration="2n" data-name="Blanca">
                <div id="blanca"></div>
                <p class="font-semibold">Blanca (2 tiempos)</p>
            </div>
            <!-- Figura: Negra -->
            <div class="rhythm-figure" data-duration="4n" data-name="Negra">
                <div id="negra"></div>
                <p class="font-semibold">Negra (1 tiempo)</p>
            </div>
            <!-- Figura: Corchea -->
            <div class="rhythm-figure" data-duration="8n" data-name="Corchea">
                <div id="corchea"></div>
                <p class="font-semibold">Corchea (1/2 tiempo)</p>
            </div>
        </div>
    </section>

    <!-- Sección de Ejercicios -->
    <section class="bg-[#115164] p-8 rounded-2xl shadow-2xl">
        <h2 class="text-3xl font-bold text-center mb-6">¡Hora de Practicar!</h2>
        <div id="exercise-container" class="text-center">
            <p id="exercise-prompt" class="text-xl mb-6 h-8"></p>
            <button id="new-exercise-btn" class="bg-[#2A9D8F] text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-[#3fdbc6] transition-transform duration-300 hover:scale-105">
                Nuevo Ejercicio
            </button>
        </div>
    </section>

</main>

<!-- Footer -->
<footer class="text-center py-12 mt-12 bg-[#052c38]">
    <div class="flex justify-center space-x-6 mb-4">
        <a href="https://wa.me/593987999154" target="_blank" class="text-2xl text-gray-400 hover:text-[#D4AF37] transition-colors"><i class="fab fa-whatsapp"></i></a>
        <a href="mailto:sprinkloud@gmail.com" class="text-2xl text-gray-400 hover:text-[#D4AF37] transition-colors"><i class="fas fa-envelope"></i></a>
        <a href="https://instagram.com/sprinkloud" target="_blank" class="text-2xl text-gray-400 hover:text-[#D4AF37] transition-colors"><i class="fab fa-instagram"></i></a>
    </div>
    <div class="text-gray-500">
        &copy; 2025 <a href="https://sprinkloud.vercel.app/" target="_blank" class="hover:text-[#D4AF37] transition-colors">SPRINKLOUD</a>
    </div>
</footer>

<script>

    // Load Verovio toolkit
    verovio.module.onRuntimeInitialized = function () {
        const toolkit = new verovio.toolkit();

        // Define rhythmic figures in PAE (Plaine & Easie) format
        const notes = {
            redonda: "@clef:G-2 @keysig: @timesig:4/4 @data:1c",
            blanca: "@clef:G-2 @keysig: @timesig:4/4 @data:2c",
            negra: "@clef:G-2 @keysig: @timesig:4/4 @data:4c",
            corchea: "@clef:G-2 @keysig: @timesig:4/4 @data:8c"
        };

        // Render each note
        for (const [id, pae] of Object.entries(notes)) {
            const svg = toolkit.renderData(pae, {
                adjustPageHeight: true,
                pageHeight: 200,
                pageWidth: 200,
                scale: 40
            });
            document.getElementById(id).innerHTML = svg;
        }
    };
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONSTANTES Y VARIABLES GLOBALES ---
        const { Renderer, Stave, StaveNote, Formatter, Voice, Accidental } = vexflow.Flow;

        const staffContainer = document.getElementById('staff-container');
        const pianoContainer = document.getElementById('piano-container');
        const startButton = document.getElementById('start-button');
        const startModal = document.getElementById('start-modal');
        const exercisePrompt = document.getElementById('exercise-prompt');
        const newExerciseBtn = document.getElementById('new-exercise-btn');

        let renderer, context, stave, voice, notes, noteElements = [];
        let synth;

        const noteMapping = [
            { vex: "c/4", tone: "C4", type: "white" }, { vex: "c#/4", tone: "C#4", type: "black" },
            { vex: "d/4", tone: "D4", type: "white" }, { vex: "d#/4", tone: "D#4", type: "black" },
            { vex: "e/4", tone: "E4", type: "white" },
            { vex: "f/4", tone: "F4", type: "white" }, { vex: "f#/4", tone: "F#4", type: "black" },
            { vex: "g/4", tone: "G4", type: "white" }, { vex: "g#/4", tone: "G#4", type: "black" },
            { vex: "a/4", tone: "A4", type: "white" }, { vex: "a#/4", tone: "A#4", type: "black" },
            { vex: "b/4", tone: "B4", type: "white" },
            { vex: "c/5", tone: "C5", type: "white" }
        ];

        let currentExercise = null;

        // --- INICIALIZACIÓN ---

        // Inicializar Tone.js al hacer clic en el botón de inicio
        startButton.addEventListener('click', async () => {
            await Tone.start();
            synth = new Tone.Synth().toDestination();
            console.log('Audio context started');
            startModal.style.display = 'none';
            init();
        });

        function init() {
            drawStaff();
            createPiano();
            setupEventListeners();
        }

        // --- VEXFLOW: DIBUJAR PENTAGRAMA ---
        function drawStaff(highlightNote = null) {
            staffContainer.innerHTML = '';
            renderer = new Renderer(staffContainer, Renderer.Backends.SVG);

            const containerWidth = staffContainer.clientWidth;
            renderer.resize(containerWidth, 150);
            context = renderer.getContext();
            context.setFont('Arial', 10, '').setBackgroundFillStyle('#115164');

            stave = new Stave(10, 20, containerWidth - 20);
            stave.addClef('treble').addTimeSignature('4/4');
            stave.setContext(context).draw();

            notes = [
                new StaveNote({ keys: ['c/4'], duration: 'q' }),
                new StaveNote({ keys: ['d/4'], duration: 'q' }),
                new StaveNote({ keys: ['e/4'], duration: 'q' }),
                new StaveNote({ keys: ['f/4'], duration: 'q' }),
                new StaveNote({ keys: ['g/4'], duration: 'q' }),
                new StaveNote({ keys: ['a/4'], duration: 'q' }),
                new StaveNote({ keys: ['b/4'], duration: 'q' }),
                new StaveNote({ keys: ['c/5'], duration: 'q' }),
            ];

            voice = new Voice({ num_beats: 8, beat_value: 4 });
            voice.addTickables(notes);

            new Formatter().joinVoices([voice]).format([voice], containerWidth - 50);

            voice.draw(context, stave);

            // Resaltar la nota seleccionada DESPUÉS de dibujarla
            if (highlightNote) {
                notes.forEach(note => {
                    if (note.getKeys()[0] === highlightNote) {
                        // Ahora note.attrs.el debería existir
                        if (note.attrs.el) {
                            note.attrs.el.querySelectorAll('path').forEach(p => {
                                p.classList.add('note-highlight');
                            });
                        }
                    }
                });
            }

            // Guardar referencia a los elementos SVG de las notas para la interactividad
            noteElements = notes.map((note, index) => ({
                element: note.attrs.el,
                noteName: note.getKeys()[0].replace('/', ''),
                vexName: note.getKeys()[0],
            }));
        }

        // --- PIANO: CREAR TECLADO ---
        function createPiano() {
            pianoContainer.innerHTML = '';
            const whiteKeys = noteMapping.filter(n => n.type === 'white');
            const keyWidth = 100 / whiteKeys.length;

            noteMapping.forEach((note, i) => {
                const key = document.createElement('div');
                key.classList.add('piano-key', `${note.type}-key`);
                key.dataset.note = note.tone;
                key.dataset.vex = note.vex;

                if(note.type === 'white') {
                    key.style.width = `${keyWidth}%`;
                    key.style.left = `${whiteKeys.findIndex(k => k.tone === note.tone) * keyWidth}%`;
                    key.style.height = '100%';
                    key.classList.add('absolute', 'bottom-0', 'rounded-b-lg');
                } else {
                    const prevWhiteKeyIndex = whiteKeys.findIndex(k => k.tone > note.tone) -1;
                    key.style.width = `${keyWidth * 0.6}%`;
                    key.style.left = `${(prevWhiteKeyIndex * keyWidth) + (keyWidth * 0.7)}%`;
                    key.style.height = '60%';
                    key.classList.add('absolute', 'top-0', 'rounded-b-md');
                }
                pianoContainer.appendChild(key);
            });
        }

        // --- INTERACTIVIDAD ---

        // Función unificada para tocar y resaltar una nota
        function playAndHighlight(toneNote, vexNote) {
            if (!synth) return;

            // 1. Tocar sonido
            synth.triggerAttackRelease(toneNote, '8n');

            // 2. Resaltar tecla del piano
            const pianoKey = document.querySelector(`.piano-key[data-note="${toneNote}"]`);
            if (pianoKey) {
                pianoKey.classList.add('key-active');
                setTimeout(() => pianoKey.classList.remove('key-active'), 200);
            }

            // 3. Resaltar nota en el pentagrama
            drawStaff(vexNote);

            // 4. Chequear ejercicio
            checkExercise(toneNote);
        }

        function setupEventListeners() {
            // Event listener para las teclas del piano
            pianoContainer.addEventListener('click', (e) => {
                const key = e.target.closest('.piano-key');
                if (key) {
                    const note = key.dataset.note;
                    const vexNote = key.dataset.vex;
                    playAndHighlight(note, vexNote);
                }
            });

            // Event listener para las notas en el pentagrama (usando delegación de eventos)
            staffContainer.addEventListener('click', e => {
                const noteElement = e.target.closest('.vf-notehead, .vf-stem, .vf-flag');
                if(noteElement) {
                    const noteGroup = noteElement.closest('.vf-stavenote');
                    if (noteGroup) {
                        const foundNote = noteElements.find(ne => ne.element === noteGroup);
                        if (foundNote) {
                            const toneNote = foundNote.noteName.charAt(0).toUpperCase() + foundNote.noteName.slice(1);
                            playAndHighlight(toneNote, foundNote.vexName);
                        }
                    }
                }
            });

            // Event listener para las figuras rítmicas
            document.querySelectorAll('.rhythm-figure').forEach(figure => {
                figure.addEventListener('click', () => {
                    const duration = figure.dataset.duration;
                    if(synth) {
                        synth.triggerAttackRelease('C4', duration);
                        // Animación de click
                        figure.classList.add('scale-95', 'transition-transform');
                        setTimeout(() => figure.classList.remove('scale-95'), 200);
                    }
                });
            });

            // Event listener para el botón de nuevo ejercicio
            newExerciseBtn.addEventListener('click', generateNewExercise);

            // Redibujar en cambio de tamaño de ventana
            window.addEventListener('resize', () => drawStaff());
        }

        // --- LÓGICA DE EJERCICIOS ---
        function generateNewExercise() {
            const notesForExercise = noteMapping.filter(n => n.type === 'white');
            const randomIndex = Math.floor(Math.random() * notesForExercise.length);
            currentExercise = notesForExercise[randomIndex];

            exercisePrompt.textContent = `Haz clic en la nota ${currentExercise.tone.slice(0, -1)} en el piano o pentagrama.`;
            exercisePrompt.className = 'text-xl mb-6 h-8'; // Reset class
        }

        function checkExercise(playedNote) {
            if (!currentExercise) return;

            const feedbackEl = newExerciseBtn.parentElement;
            if (playedNote === currentExercise.tone) {
                exercisePrompt.textContent = '¡Correcto! ¡Muy bien!';
                feedbackEl.classList.add('feedback-correct');
                currentExercise = null; // Terminar ejercicio
            } else {
                exercisePrompt.textContent = `¡Casi! Esa fue otra nota. Intenta de nuevo.`;
                feedbackEl.classList.add('feedback-incorrect');
            }

            setTimeout(() => {
                feedbackEl.classList.remove('feedback-correct', 'feedback-incorrect');
                if(!currentExercise) { // Si ya se completó el ejercicio
                    exercisePrompt.textContent = 'Haz clic en "Nuevo Ejercicio" para continuar.';
                } else { // Si se equivocó, restaurar el prompt
                    exercisePrompt.textContent = `Haz clic en la nota ${currentExercise.tone.slice(0, -1)} en el piano o pentagrama.`;
                }
            }, 1500);
        }
    });
</script>
</body>
</html>


